<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OdooOrderProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">beemediate</a> &gt; <a href="index.source.html" class="el_package">com.beemediate.beemediate.infrastructure.odoo</a> &gt; <span class="el_source">OdooOrderProvider.java</span></div><h1>OdooOrderProvider.java</h1><pre class="source lang-java linenums">package com.beemediate.beemediate.infrastructure.odoo;

import java.net.MalformedURLException;
import java.net.URISyntaxException;

import javax.security.auth.login.FailedLoginException;

import org.apache.xmlrpc.XmlRpcException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.beemediate.beemediate.domain.pojo.order.Order;
import com.beemediate.beemediate.domain.pojo.order.OrderStructure;
import com.beemediate.beemediate.domain.ports.infrastructure.odoo.OrderProviderPort;
import com.beemediate.beemediate.infrastructure.odoo.config.OdooApiConfig;
import com.beemediate.beemediate.infrastructure.odoo.dto.ArticoloPreventivoDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.CompagniaDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ConsegnaDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ContattoConsegnaDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.DestinazioneDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.FornitoreDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.PreventivoDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ProdottoDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ProdottoFornitoreDTO;
import com.beemediate.beemediate.infrastructure.odoo.exceptions.EmptyFetchException;
import com.beemediate.beemediate.infrastructure.odoo.exceptions.InconsistentDTOException;
import com.beemediate.beemediate.infrastructure.odoo.mapper.OrderMapper;

/**
 * Adattatore che implementa OrderProviderPort. Recupera gli ordini di acquisto dal CRM Odoo, ricostruisce i corrispondenti Order e li conserva in un buffer.
 */
@Component
public class OdooOrderProvider implements OrderProviderPort{
	
	/**
	 * Buffer con singolo elemento Order.
	 */
<span class="nc" id="L40">	private Order ordine = null;</span>
	
	/***riferimento a Logger*/
<span class="nc" id="L43">	private final Logger log = LoggerFactory.getLogger(OdooOrderProvider.class);</span>
	/***Riferimento a Configurazione per autenticazione e comunicazione con CRM Odoo usando il protocollo XML-RPC.*/
	private final OdooApiConfig odoo;
	
	private static final String UNSAFE_CHARS_REGEX=&quot;[\r\n]&quot;;
	
	
	/**
	 * Costruttore
	 * @param odoo - configurazione per autenticazione e comunicazione con Odoo via XML-RPC
	 */
	@Autowired
<span class="nc" id="L55">	public OdooOrderProvider(final OdooApiConfig odoo) {</span>
<span class="nc" id="L56">		this.odoo = odoo;</span>
<span class="nc" id="L57">	}</span>


	
	@Override
	public Order popNewOrder() {
<span class="nc" id="L63">		final Order o = ordine;</span>
<span class="nc" id="L64">		ordine = null;</span>
<span class="nc" id="L65">		return o;</span>
	}



	@Override
	public boolean hasNewOrder() {
<span class="nc bnc" id="L72" title="All 2 branches missed.">		return ordine != null;</span>
	}



	@Override
	public boolean fetchOrders() {
		
		try {
<span class="nc" id="L81">			return fetchData();</span>
<span class="nc" id="L82">		}catch(MalformedURLException | FailedLoginException | XmlRpcException | URISyntaxException e){</span>
<span class="nc" id="L83">			log.error(&quot;Problema nel recupero degli ordini.&quot;,e);</span>
		}
		
<span class="nc" id="L86">		return false;</span>
	}
	
	
	//*******************************************//	
	//******** metodi helper di servizio ********//
	//*******************************************//
	
	
	/**
	 * Richiede via XML-RPC le informazioni dei model di Odoo e ricostruisce l'oggetto Order.
	 * @return &lt;i&gt;true&lt;/i&gt; se viene creato un nuovo Order.
	 * @throws MalformedURLException
	 * @throws FailedLoginException
	 * @throws XmlRpcException
	 * @throws URISyntaxException 
	 */
	private boolean fetchData() throws FailedLoginException, XmlRpcException, URISyntaxException, MalformedURLException {
		
		// se non si Ã¨ connessi, prova una connessione.
<span class="nc bnc" id="L106" title="All 2 branches missed.">		if(!odoo.isOnline())</span>
<span class="nc" id="L107">			odoo.connect();</span>
		
		
<span class="nc" id="L110">		ordine = null;</span>
		
		try {
			
			final FornitoreDTO f;
			final PreventivoDTO prev;
			final ArticoloPreventivoDTO[] artpr;
			final ProdottoFornitoreDTO[] prodf;
			final DestinazioneDTO dest;
			final CompagniaDTO comp;
			final OrderStructure ordstr;
			
			
			//trova ed estrai GEALAN (e stampa su log)
<span class="nc" id="L124">			f = FornitoreDTO.fromXMLRPC(odoo);</span>
<span class="nc" id="L125">			log.info(f.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			
			//trova ed estrai preventivo (e stampa su log)
<span class="nc" id="L129">			prev = PreventivoDTO.fromXMLRPC(odoo, f);</span>
<span class="nc" id="L130">			log.info(prev.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			
			//trova informazioni sulla delivery specificata nel preventivo (e stampa su log)
<span class="nc" id="L134">			dest = DestinazioneDTO.fromXMLRPC(</span>
<span class="nc" id="L135">							odoo,</span>
<span class="nc" id="L136">							ContattoConsegnaDTO.fromXMLRPC(</span>
<span class="nc" id="L137">										odoo,</span>
<span class="nc" id="L138">										ConsegnaDTO.fromXMLRPC(odoo, prev)</span>
									)
							);
<span class="nc" id="L141">			log.info(dest.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			//trova informazioni sulla compagnia cliente (e stampa su log)
<span class="nc" id="L144">			comp = CompagniaDTO.fromXMLRPC(odoo, prev);</span>
<span class="nc" id="L145">			log.info(comp.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			//trova ed estrai parti del preventivo (e stampa su log)
<span class="nc" id="L148">			artpr = ArticoloPreventivoDTO.fromXMLRPC(odoo, prev);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			for(ArticoloPreventivoDTO p : artpr) {</span>
<span class="nc" id="L150">				log.info(p.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			}
			
			//per ogni prodotto associato ad una parte del preventivo, trova ed estrai info su catalogo fornitore (e stampa su log)
<span class="nc" id="L154">			prodf = ProdottoFornitoreDTO.fromXMLRPC(</span>
<span class="nc" id="L155">								odoo,</span>
<span class="nc" id="L156">								ProdottoDTO.fromXMLRPC(odoo, artpr),</span>
<span class="nc" id="L157">								f</span>
							);
<span class="nc bnc" id="L159" title="All 2 branches missed.">			for(ProdottoFornitoreDTO p : prodf) {</span>
<span class="nc" id="L160">				log.info(p.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			}
			
			//costruzione struct ordine
<span class="nc" id="L164">			ordstr=OrderMapper.map(f, prev, artpr, prodf, dest, comp);</span>
<span class="nc" id="L165">			log.info(ordstr.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			//costruzione ordine
<span class="nc" id="L167">			ordine = new Order(ordstr, ordstr.getHeader().getOrderID() );</span>
			
			
<span class="nc" id="L170">		} catch (InconsistentDTOException | ClassCastException e1) {</span>
<span class="nc" id="L171">			log.error(&quot;Problema nel recupero degli ordini.&quot;,e1);</span>
<span class="nc" id="L172">		} catch(EmptyFetchException e) {</span>
<span class="nc" id="L173">			log.info(&quot;Problema nel recupero degli ordini.&quot;,e);</span>
		}
		
<span class="nc" id="L176">		return hasNewOrder();</span>
		
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>