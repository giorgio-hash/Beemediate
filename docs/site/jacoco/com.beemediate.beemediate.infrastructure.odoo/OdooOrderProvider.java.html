<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OdooOrderProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">beemediate</a> &gt; <a href="index.source.html" class="el_package">com.beemediate.beemediate.infrastructure.odoo</a> &gt; <span class="el_source">OdooOrderProvider.java</span></div><h1>OdooOrderProvider.java</h1><pre class="source lang-java linenums">package com.beemediate.beemediate.infrastructure.odoo;

import java.net.MalformedURLException;
import java.net.URISyntaxException;

import javax.security.auth.login.FailedLoginException;

import org.apache.xmlrpc.XmlRpcException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.beemediate.beemediate.domain.pojo.order.Order;
import com.beemediate.beemediate.domain.pojo.order.OrderStructure;
import com.beemediate.beemediate.domain.ports.infrastructure.odoo.OrderProviderPort;
import com.beemediate.beemediate.infrastructure.odoo.config.OdooApiConfig;
import com.beemediate.beemediate.infrastructure.odoo.dto.ArticoloPreventivoDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.CompagniaDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ConsegnaDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ContattoConsegnaDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.DestinazioneDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.FornitoreDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.PreventivoDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ProdottoDTO;
import com.beemediate.beemediate.infrastructure.odoo.dto.ProdottoFornitoreDTO;
import com.beemediate.beemediate.infrastructure.odoo.exceptions.EmptyFetchException;
import com.beemediate.beemediate.infrastructure.odoo.exceptions.InconsistentDTOException;
import com.beemediate.beemediate.infrastructure.odoo.mapper.OrderMapper;

/**
 * Adattatore che implementa OrderProviderPort. Recupera gli ordini di acquisto dal CRM Odoo, ricostruisce i corrispondenti Order e li conserva in un buffer.
 */
@Component
public class OdooOrderProvider implements OrderProviderPort{
	
	/**
	 * Buffer con singolo elemento Order.
	 */
<span class="fc" id="L40">	private Order ordine = null;</span>
	
	/***riferimento a Logger*/
<span class="fc" id="L43">	private final Logger log = LoggerFactory.getLogger(OdooOrderProvider.class);</span>
	/***Riferimento a Configurazione per autenticazione e comunicazione con CRM Odoo usando il protocollo XML-RPC.*/
	private final OdooApiConfig odoo;
	
	private static final String UNSAFE_CHARS_REGEX=&quot;[\r\n]&quot;;
	
	private static final String PROBLEMA_ORDINI_MSG = &quot;Problema nel recupero degli ordini.&quot;;
	
	/**
	 * Costruttore
	 * @param odoo - configurazione per autenticazione e comunicazione con Odoo via XML-RPC
	 */
	@Autowired
<span class="fc" id="L56">	public OdooOrderProvider(final OdooApiConfig odoo) {</span>
<span class="fc" id="L57">		this.odoo = odoo;</span>
<span class="fc" id="L58">	}</span>


	
	@Override
	public Order popNewOrder() {
<span class="fc" id="L64">		final Order o = ordine;</span>
<span class="fc" id="L65">		ordine = null;</span>
<span class="fc" id="L66">		return o;</span>
	}



	@Override
	public boolean hasNewOrder() {
<span class="fc bfc" id="L73" title="All 2 branches covered.">		return ordine != null;</span>
	}



	@Override
	public boolean fetchOrders() {
		
		try {
<span class="fc" id="L82">			return fetchData();</span>
<span class="fc" id="L83">		}catch(MalformedURLException | FailedLoginException | XmlRpcException | URISyntaxException e){</span>
<span class="fc" id="L84">			log.error(PROBLEMA_ORDINI_MSG,e);</span>
		}
		
<span class="fc" id="L87">		return false;</span>
	}
	
	
	//*******************************************//	
	//******** metodi helper di servizio ********//
	//*******************************************//
	
	
	/**
	 * Richiede via XML-RPC le informazioni dei model di Odoo e ricostruisce l'oggetto Order.
	 * @return &lt;i&gt;true&lt;/i&gt; se viene creato un nuovo Order.
	 * @throws MalformedURLException
	 * @throws FailedLoginException
	 * @throws XmlRpcException
	 * @throws URISyntaxException 
	 */
	private boolean fetchData() throws FailedLoginException, XmlRpcException, URISyntaxException, MalformedURLException {
		
		// se non si Ã¨ connessi, prova una connessione.
<span class="fc bfc" id="L107" title="All 2 branches covered.">		if(!odoo.isOnline())</span>
<span class="fc" id="L108">			odoo.connect();</span>
		
		
<span class="fc" id="L111">		ordine = null;</span>
		
		try {
			
			final FornitoreDTO f;
			final PreventivoDTO prev;
			final ArticoloPreventivoDTO[] artpr;
			final ProdottoFornitoreDTO[] prodf;
			final DestinazioneDTO dest;
			final CompagniaDTO comp;
			final OrderStructure ordstr;
			
			
			//trova ed estrai GEALAN (e stampa su log)
<span class="fc" id="L125">			f = FornitoreDTO.fromXMLRPC(odoo);</span>
<span class="fc" id="L126">			log.info(f.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			
			//trova ed estrai preventivo (e stampa su log)
<span class="fc" id="L130">			prev = PreventivoDTO.fromXMLRPC(odoo, f);</span>
<span class="fc" id="L131">			log.info(prev.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			
			//trova informazioni sulla delivery specificata nel preventivo (e stampa su log)
<span class="fc" id="L135">			dest = DestinazioneDTO.fromXMLRPC(</span>
							odoo,
<span class="fc" id="L137">							ContattoConsegnaDTO.fromXMLRPC(</span>
										odoo,
<span class="fc" id="L139">										ConsegnaDTO.fromXMLRPC(odoo, prev)</span>
									)
							);
<span class="fc" id="L142">			log.info(dest.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			//trova informazioni sulla compagnia cliente (e stampa su log)
<span class="fc" id="L145">			comp = CompagniaDTO.fromXMLRPC(odoo, prev);</span>
<span class="fc" id="L146">			log.info(comp.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			
			//trova ed estrai parti del preventivo (e stampa su log)
<span class="fc" id="L149">			artpr = ArticoloPreventivoDTO.fromXMLRPC(odoo, prev);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">			for(ArticoloPreventivoDTO p : artpr) {</span>
<span class="fc" id="L151">				log.info(p.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			}
			
			//per ogni prodotto associato ad una parte del preventivo, trova ed estrai info su catalogo fornitore (e stampa su log)
<span class="fc" id="L155">			prodf = ProdottoFornitoreDTO.fromXMLRPC(</span>
								odoo,
<span class="fc" id="L157">								ProdottoDTO.fromXMLRPC(odoo, artpr),</span>
								f
							);
<span class="fc bfc" id="L160" title="All 2 branches covered.">			for(ProdottoFornitoreDTO p : prodf) {</span>
<span class="fc" id="L161">				log.info(p.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			}
			
			//costruzione struct ordine
<span class="fc" id="L165">			ordstr=OrderMapper.map(f, prev, artpr, prodf, dest, comp);</span>
<span class="fc" id="L166">			log.info(ordstr.toString().replaceAll(UNSAFE_CHARS_REGEX,&quot;&quot;));</span>
			//costruzione ordine
<span class="fc" id="L168">			ordine = new Order(ordstr, ordstr.getHeader().getOrderID() );</span>
			
			
<span class="fc" id="L171">		} catch (InconsistentDTOException | ClassCastException e1) {</span>
<span class="fc" id="L172">			log.error(PROBLEMA_ORDINI_MSG,e1);</span>
<span class="fc" id="L173">		} catch(EmptyFetchException e) {</span>
<span class="fc" id="L174">			log.info(PROBLEMA_ORDINI_MSG,e);</span>
<span class="fc" id="L175">		}</span>
		
<span class="fc" id="L177">		return hasNewOrder();</span>
		
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>