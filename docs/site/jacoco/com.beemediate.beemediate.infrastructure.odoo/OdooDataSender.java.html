<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OdooDataSender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">beemediate</a> &gt; <a href="index.source.html" class="el_package">com.beemediate.beemediate.infrastructure.odoo</a> &gt; <span class="el_source">OdooDataSender.java</span></div><h1>OdooDataSender.java</h1><pre class="source lang-java linenums">package com.beemediate.beemediate.infrastructure.odoo;

import java.net.MalformedURLException;
import java.net.URISyntaxException;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

import javax.security.auth.login.FailedLoginException;

import org.apache.xmlrpc.XmlRpcException;
import org.owasp.encoder.Encode;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.beemediate.beemediate.domain.pojo.confirmation.Confirmation;
import com.beemediate.beemediate.domain.pojo.confirmation.ConfirmationStructure;
import com.beemediate.beemediate.domain.pojo.order.Order;
import com.beemediate.beemediate.domain.ports.infrastructure.odoo.DataSenderPort;
import com.beemediate.beemediate.infrastructure.ftp.exceptions.NullSuppliedArgumentException;
import com.beemediate.beemediate.infrastructure.odoo.config.OafStatus;
import com.beemediate.beemediate.infrastructure.odoo.config.OdooApiConfig;
import com.beemediate.beemediate.infrastructure.odoo.exceptions.EmptyFetchException;
import com.beemediate.beemediate.infrastructure.odoo.exceptions.InconsistentDTOException;

/***Adattatore per comunicare con Odoo External API via protocollo XML-RPC. 
 * Riferirsi alla documentazione ufficiale di Odoo per ulteriori informazioni.*/
@Component
public class OdooDataSender implements DataSenderPort{

	/***logger di {@code Slf4j}*/
<span class="nc" id="L34">	private final Logger log = LoggerFactory.getLogger(OdooDataSender.class);</span>
	/***Configurazione per comunicare con API del CRM Odoo.*/
	private final OdooApiConfig odoo;

	/**
	 * Messaggio di errore
	 */
	private static final String ERROR_MSG_ODOODB = &quot;Problema nella scrittura del db Odoo.&quot;;
	
	/***
	 * Costruttore
	 * @param oggetto {@code OdooApiConfig}*/
	@Autowired
<span class="nc" id="L47">	public OdooDataSender(final OdooApiConfig odoo) {</span>
<span class="nc" id="L48">		this.odoo = odoo;</span>
<span class="nc" id="L49">	}</span>
	
	
	@Override
	public boolean signalConfirmation(final Confirmation c) {
		
<span class="nc" id="L55">		return executeSignalSafely(c, OafStatus.CONFIRMED);</span>
		
	}
	
	@Override
	public boolean signalShipped(final Order o) {

<span class="nc" id="L62">		return executeSignalSafely(o, OafStatus.SHIPPED);</span>
		
	}

	@Override
	public boolean signalOpenTransError(final Order o) {

<span class="nc" id="L69">		return executeSignalSafely(o, OafStatus.OPENTRANSERROR);</span>
		
	}

	@Override
	public boolean signalContentError(final  Order o) {
		
<span class="nc" id="L76">		return executeSignalSafely(o, OafStatus.CONTENTERROR);</span>
	
	}
	
	
	
	//*******************************************//	
	//******** metodi helper di servizio ********//
	//*******************************************//

	/**
	 * Esegue in modo sicuro l'invio di uno stato verso Odoo invocando signal(...)
	 * e catturando tutte le checked exception legate alla comunicazione/URL.
	 * &lt;ul&gt;
	 * &lt;li&gt; Se signal() completa correttamente ritorna il suo valore booleano.&lt;/li&gt;
	 * &lt;li&gt; Se viene sollevata una delle eccezioni previste viene loggato l'errore
	 *   e viene restituito false (fallimento silenzioso gestito qui).&lt;/li&gt;
	 * &lt;/ul&gt;
	 */
	private boolean executeSignalSafely(Object o, OafStatus status) {
		
		try {
			// se non si è connessi, prova una connessione.
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if(!odoo.isOnline())</span>
<span class="nc" id="L100">				odoo.connect();</span>
			
<span class="nc bnc" id="L102" title="All 2 branches missed.">			return status == OafStatus.CONFIRMED? signal((Confirmation) o ) : signal((Order) o, status);</span>
			
<span class="nc" id="L104">		} catch (FailedLoginException | MalformedURLException | XmlRpcException | URISyntaxException | InconsistentDTOException | NullSuppliedArgumentException | EmptyFetchException e) {</span>
<span class="nc" id="L105">			log.error(ERROR_MSG_ODOODB,e);</span>
		}
		
<span class="nc" id="L108">		return false;</span>
	}
	
	
	/**
	 * Segnala (invia) un aggiornamento di stato per un ordine al servizio Odoo.
	 *
	 * Se non è connesso al servizio Odoo, tenta una connessione chiamando {@code odoo.connect()}.
	 * Successivamente prova ad aggiornare lo stato dell'ordine nel database remoto tramite
	 * {@code updateTo(orderId, status)}. Se durante la scrittura verso Odoo si verifica una
	 * {@link org.apache.xmlrpc.XmlRpcException}, questa viene catturata e loggata e la
	 * funzione restituisce {@code false}.
	 *
	 * @param o l'ordine da aggiornare; non deve essere {@code null}
	 * @param status lo stato che si vuole impostare; non deve essere {@code null}
	 * @return {@code true} se l'aggiornamento è andato a buon fine, {@code false} altrimenti
	 *         (compreso il caso in cui si verifichi un {@link org.apache.xmlrpc.XmlRpcException}
	 *         durante la scrittura, che viene gestita internamente)
	 * @throws FailedLoginException se il tentativo di connessione a Odoo fallisce a causa di credenziali non valide
	 * @throws MalformedURLException se l'URL usato per connettersi a Odoo è malformato
	 * @throws XmlRpcException se altre chiamate non gestite internamente sollevano questa eccezione.
	 *         Nota: l'eventuale {@code XmlRpcException} generata da {@code updateTo(...)} è
	 *         catturata all'interno del metodo e non viene propagata.
	 * @throws URISyntaxException se l'URI usato per la connessione è invalido
	 * @throws EmptyFetchException 
	 * @throws NullSuppliedArgumentException 
	 */
	private boolean signal(Order o, OafStatus status) throws NullSuppliedArgumentException, EmptyFetchException, XmlRpcException {
		
<span class="nc" id="L137">		boolean res = updateTo(o.getOrderID(), status.toString() );</span>
<span class="nc" id="L138">		log.info(&quot;Inviato update OaF di {} a {}.&quot;,o.getOrderID(),status.toString());</span>
		
<span class="nc" id="L140">		return res;</span>
	}
	

	/**
	 * Segnala (invia) la conferma di un ordine al servizio Odoo e crea l'annotazione di workflow
	 * corrispondente.
	 *
	 * Il metodo verifica prima se esiste una connessione attiva verso Odoo e, in caso negativo,
	 * tenta di connettersi chiamando {@code odoo.connect()}. Recupera i dati dalla
	 * {@link Confirmation} fornita, usa {@code updateTo(orderId, status)} per aggiornare lo stato
	 * dell'ordine su Odoo impostandolo su {@code OafStatus.CONFIRMED} e, successivamente,
	 * crea una workflow annotation tramite {@code createWorkflowAnnotation(resourceID, data)}.
	 *
	 * Eventuali {@link org.apache.xmlrpc.XmlRpcException} o {@link InconsistentDTOException}
	 * sollevate durante la scrittura sul DB remoto (ad es. da {@code updateTo} o
	 * {@code createWorkflowAnnotation}) vengono catturate qui, loggate e non vengono propagate.
	 *
	 * @param c la conferma da processare (non deve essere {@code null}); da essa vengono letti
	 *          {@link ConfirmationStructure} e l'ID della risorsa. Il metodo si aspetta che
	 *          {@code c.getData()} e {@code c.getConfirmationId()} ritornino valori validi.
	 * @return {@code true} se l'aggiornamento dello stato su Odoo è andato a buon fine,
	 *         {@code false} in caso contrario (inclusi i casi in cui si verifica un'eccezione
	 *         gestita internamente e loggata)
	 * @throws XmlRpcException se una chiamata di connessione/interazione con Odoo (es. {@code odoo.connect()})
	 *         solleva questa eccezione prima che venga eseguito l'aggiornamento; le XmlRpcException
	 *         sollevate da {@code updateTo(...)} o {@code createWorkflowAnnotation(...)} sono invece
	 *         catturate e non propagate.
	 * @throws InconsistentDTOException 
	 * @throws EmptyFetchException 
	 * @throws NullSuppliedArgumentException 
	 */
	private boolean signal(Confirmation c) throws InconsistentDTOException, NullSuppliedArgumentException, EmptyFetchException, XmlRpcException {
		
<span class="nc" id="L174">		final String stato = OafStatus.CONFIRMED.toString();</span>
<span class="nc" id="L175">		boolean res = false;</span>
<span class="nc" id="L176">		ConfirmationStructure data = c.getData();</span>
<span class="nc" id="L177">		String resourceID = c.getConfirmationId();</span>
		
<span class="nc" id="L179">		res = updateTo(data.getOrderId(),  stato );</span>
<span class="nc" id="L180">		log.info(&quot;Inviato update OaF di {} a {}.&quot;,data.getOrderId(), stato);</span>
<span class="nc" id="L181">		createWorkflowAnnotation(resourceID, data);</span>
<span class="nc" id="L182">		log.info(&quot;Inviato a {} messaggio di conferma d'ordine sul workflow.&quot;,data.getOrderId());</span>

<span class="nc" id="L184">		return res;</span>
	}
	
	
	/**
	 * Aggiorna il model &lt;tt&gt;purchase.order&lt;/tt&gt; di Odoo modificando il valore di &lt;tt&gt;x_studio_oaf&lt;/tt&gt; dell'ordine di acquisto a &lt;i&gt;CONFIRMED, SHIPPED, OPENTRANSERROR, CONTENTERROR&lt;/i&gt;. Per maggiori informazioni sui valori di &lt;tt&gt;x_studio_oaf&lt;/tt&gt; vedi la classe enum {@code OafStatus } in {@code OdooApiConfig}.
	 * @param orderId - String per identificare ordine di acquisto nel sistema CRM
	 * @param oafState - String
	 * @return &lt;i&gt;true&lt;/i&gt; se l'operazione è andata a buon fine
	 * @throws XmlRpcException per problemi legati alla applicazione del protocollo XML-RPC
	 * @throws EmptyFetchException per problemi legati alla ricerca dell'ordine obiettivo
	 * @throws NullSuppliedArgumentException
	 */
	private boolean updateTo(final String orderId, final String oafState) throws XmlRpcException, NullSuppliedArgumentException, EmptyFetchException {
		
<span class="nc bnc" id="L199" title="All 4 branches missed.">		if(orderId==null || oafState==null)</span>
<span class="nc" id="L200">			throw new NullSuppliedArgumentException (&quot;Non sono ammessi argomenti null&quot;);</span>
		
		Object[] ids;
<span class="nc" id="L203">		final Map&lt;String, Object&gt; requestInfo = new HashMap&lt;&gt;();</span>
		
<span class="nc" id="L205">		requestInfo.clear();</span>
<span class="nc" id="L206">		requestInfo.put(&quot;limit&quot;, 1);</span>
<span class="nc" id="L207">		ids = odoo.searchFromModel(&quot;purchase.order&quot;, requestInfo, Arrays.asList(&quot;name&quot;,&quot;=&quot;,orderId));</span>
		
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if(ids.length == 0) throw new EmptyFetchException(&quot;Ordine &quot;+orderId+&quot; da aggiornare non è stato trovato&quot;);</span>
		
<span class="nc" id="L211">		requestInfo.clear();		</span>
<span class="nc" id="L212">		requestInfo.put(&quot;x_studio_oaf&quot;, oafState );</span>
		
<span class="nc" id="L214">		return odoo.updateOnModel(&quot;purchase.order&quot;, requestInfo, ids[0]);</span>
		
	}
	
	
	/**
	 * Crea un'annotazione di workflow (un messaggio) su Odoo associata all'ordine identificato
	 * da {@code cs.getOrderId()}.
	 *
	 * Il metodo esegue una ricerca su Odoo (model &quot;purchase.order&quot;) usando come filtro
	 * {@code [[&quot;name&quot;,&quot;=&quot;, cs.getOrderId()]]} e richiede al massimo un risultato
	 * (requestInfo con &quot;limit&quot; = 1). Se non viene trovato alcun ordine o se è presente
	 * ambiguità sull'ordine trovato, viene sollevata un'eccezione di tipo
	 * {@link InconsistentDTOException}. Se la ricerca ha successo viene creato un nuovo
	 * record sul model &quot;mail.message&quot; con:
	 *  - model = &quot;purchase.order&quot;
	 *  - res_id = id dell'ordine trovato
	 *  - message_type = &quot;comment&quot;
	 *  - body = risultato di {@code writeConfirmationMessage(filename, cs)}
	 *
	 * Le chiamate remote ad Odoo vengono effettuate tramite {@code odoo.models.execute} e
	 * possono generare {@link org.apache.xmlrpc.XmlRpcException} che vengono propagate.
	 *
	 * @param filename nome (ID della risorsa/file) passato a {@code writeConfirmationMessage}
	 *                 e incluso nel corpo del messaggio; non deve essere {@code null}
	 * @param cs struttura di conferma da cui ricavare l'ordine e i dettagli del messaggio;
	 *           non deve essere {@code null} e ci si aspetta che {@code cs.getOrderId()}
	 *           ritorni un valore valido
	 * @throws XmlRpcException se una chiamata XML-RPC verso Odoo fallisce (search/create)
	 * @throws InconsistentDTOException se la ricerca dell'ordine non è univoca oppure non
	 *         ritorna alcun risultato (rispettivamente &quot;name ambiguo&quot; o &quot;name non trovato&quot;)
	 */	
	private void createWorkflowAnnotation(String filename, ConfirmationStructure cs) throws XmlRpcException, InconsistentDTOException {
		
		Object[] ids;
		Object[] res;
<span class="nc" id="L250">		Map&lt;String, Object&gt; requestInfo = new HashMap&lt;&gt;();</span>
		
<span class="nc" id="L252">		requestInfo.clear();</span>
<span class="nc" id="L253">		requestInfo.put(&quot;limit&quot;, 1);</span>
<span class="nc" id="L254">		ids = odoo.searchFromModel(&quot;purchase.order&quot;, requestInfo, Arrays.asList(&quot;name&quot;,&quot;=&quot;,cs.getOrderId()));</span>
		
<span class="nc bnc" id="L256" title="All 2 branches missed.">		if (ids.length!=1) throw new InconsistentDTOException(&quot;name ambiguo o non trovato&quot;);</span>
		
		//crea messaggio
<span class="nc" id="L259">		requestInfo.clear();</span>
<span class="nc" id="L260">		requestInfo.put(&quot;model&quot;,&quot;purchase.order&quot;);</span>
<span class="nc" id="L261">		requestInfo.put(&quot;res_id&quot;,ids[0]);</span>
<span class="nc" id="L262">		requestInfo.put(&quot;message_type&quot;, &quot;comment&quot;);</span>
<span class="nc" id="L263">		requestInfo.put(&quot;body&quot;, writeConfirmationMessage(filename, cs));</span>
		
<span class="nc" id="L265">		int msgId = odoo.insertOnModel(&quot;mail.message&quot;, requestInfo);</span>
<span class="nc" id="L266">		log.info(&quot;Risposta dal model: {}&quot;,msgId);</span>
<span class="nc" id="L267">	}</span>
	
	/**
	 * Costruisce il corpo HTML del messaggio di conferma (workflow annotation) da inviare a Odoo.
	 *
	 * Il messaggio include un'intestazione fissa &quot;ORDERRESPONSE&quot;, informazioni sul file
	 * archiviato, l'ID dell'ordine e una lista con data notifica, data di consegna,
	 * numero totale di articoli, indirizzo di spedizione e l'importo lordo con valuta.
	  *
	  * N.B.: Costruisce il corpo HTML del messaggio di conferma, escapando i valori forniti con
	  * OWASP Java Encoder per prevenire XSS e rottura del markup.
	  *
	 * @param filename il nome del file archiviato relativo alla conferma; non deve essere {@code null}
	 * @param cs la struttura di conferma contenente i campi usati per popolare il messaggio;
	 *           non deve essere {@code null}. Il metodo si aspetta che i metodi di accesso
	 *           (es. {@code getOrderId()}, {@code getDeliveryDate()}, ecc.) restituiscano valori validi.
	 * @return una {@link String} contenente il corpo del messaggio in formato HTML
	 */	
	private String writeConfirmationMessage(String filename, ConfirmationStructure cs) {
	    // Format/convert i valori (date/numero) a stringa prima di codificarli
<span class="nc bnc" id="L287" title="All 2 branches missed.">	    String fn = Encode.forHtmlContent(filename == null ? &quot;&quot; : filename);</span>
<span class="nc" id="L288">	    String orderId = Encode.forHtmlContent(cs.getOrderId());</span>
<span class="nc" id="L289">	    String responseDate = Encode.forHtmlContent(String.valueOf(cs.getOrderResponseDate()));</span>
<span class="nc" id="L290">	    String deliveryDate = Encode.forHtmlContent(String.valueOf(cs.getDeliveryDate()));</span>
<span class="nc" id="L291">	    String totalItems = Encode.forHtmlContent(String.valueOf(cs.getTotalItemNum()));</span>
<span class="nc" id="L292">	    String addrName = Encode.forHtmlContent(cs.getAddressName());</span>
<span class="nc" id="L293">	    String addrStreet = Encode.forHtmlContent(cs.getAddressStreet());</span>
<span class="nc" id="L294">	    String addrCity = Encode.forHtmlContent(cs.getAddressCity());</span>
<span class="nc" id="L295">	    String addrCountry = Encode.forHtmlContent(cs.getAddressCountry());</span>
<span class="nc" id="L296">	    String addrCountryCoded = Encode.forHtmlContent(cs.getAddressCountryCoded());</span>
<span class="nc" id="L297">	    String totalAmount = Encode.forHtmlContent(String.valueOf(cs.getTotalAmount()));</span>
<span class="nc" id="L298">	    String currency = Encode.forHtmlContent(cs.getCurrency());</span>
<span class="nc" id="L299">		return new StringBuilder()</span>
<span class="nc" id="L300">				.append(&quot;ORDERRESPONSE&quot;)</span>
<span class="nc" id="L301">				.append(&quot;&lt;p&gt;&quot;)</span>
<span class="nc" id="L302">					.append(&quot;Archiviato il file &quot;)</span>
<span class="nc" id="L303">					.append(fn)</span>
<span class="nc" id="L304">					.append(&quot; con risposta all'ordine &quot;)</span>
<span class="nc" id="L305">					.append('\&quot;').append(orderId).append('\&quot;')</span>
<span class="nc" id="L306">					.append('.')</span>
<span class="nc" id="L307">				.append(&quot;&lt;/p&gt;&quot;)</span>
<span class="nc" id="L308">				.append(&quot;&lt;ul&gt;&quot;)</span>
<span class="nc" id="L309">					.append(&quot;&lt;li&gt;&quot;).append(&quot;Data notifica: &quot;)</span>
<span class="nc" id="L310">										.append(responseDate)</span>
<span class="nc" id="L311">										.append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L312">					.append(&quot;&lt;li&gt;&quot;).append(&quot;Data Consegna:&quot;)</span>
<span class="nc" id="L313">										.append(deliveryDate)</span>
<span class="nc" id="L314">										.append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L315">					.append(&quot;&lt;li&gt;&quot;).append(totalItems).append(&quot; articoli spediti a:&quot;)</span>
<span class="nc" id="L316">											.append(&quot;&lt;ul style=\&quot;list-style-type:none;\&quot;&gt;&quot;)</span>
<span class="nc" id="L317">												.append(&quot;&lt;li&gt;&quot;).append(addrName).append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L318">												.append(&quot;&lt;li&gt;&quot;).append(addrStreet).append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L319">												.append(&quot;&lt;li&gt;&quot;).append(addrCity)</span>
<span class="nc" id="L320">																	.append(&quot;, &quot;).append(addrCountry)</span>
<span class="nc" id="L321">																	.append('(').append(addrCountryCoded).append(')')</span>
<span class="nc" id="L322">																	.append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L323">											.append(&quot;&lt;/ul&gt;&quot;)</span>
<span class="nc" id="L324">										.append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L325">					.append(&quot;&lt;li&gt;&quot;).append(&quot;Importo lordo: &quot;)</span>
<span class="nc" id="L326">										.append(totalAmount).append(' ')</span>
<span class="nc" id="L327">										.append(currency)</span>
<span class="nc" id="L328">										.append(&quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L329">				.append(&quot;&lt;/ul&gt;&quot;)</span>
<span class="nc" id="L330">				.append(&quot;&lt;p&gt;Vedi file archiviato per altre informazioni.&lt;/p&gt;&quot;)</span>
<span class="nc" id="L331">				.toString();</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>